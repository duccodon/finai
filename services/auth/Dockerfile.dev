FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

# install netcat for port check
RUN apk add --no-cache netcat-openbsd

COPY . .

# ensure entrypoint exists at ./entrypoint.sh (relative to build context)
# Copy entrypoint.sh to a safe place outside /app
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
# Fix Windows CRLF endings if present, then make it executable
RUN sed -i 's/\r$//' /usr/local/bin/entrypoint.sh \
    && chmod +x /usr/local/bin/entrypoint.sh

# Use entrypoint directly
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
